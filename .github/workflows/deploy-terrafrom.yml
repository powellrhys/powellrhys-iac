name: Deploy Terraform

on:
  push:
    branches:
      - 'feature/**'

  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - '**'

jobs:
  plan:
    name: Plan
    uses: ./.github/workflows/template-plan-apply-terraform.yml
    with:
      # tf_state_resource_group_name: tfstate-rg
      # tf_state_storage_account: powellrhystfstate
      # tf_state_container_name: tfstate
      # tf_state_key: powellrhys.tfstate
      should_apply: 'false'
      tf_directory: 'infra'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

  apply:
    needs: plan
    name: Apply
    uses: ./.github/workflows/template-plan-apply-terraform.yml
    with:
      # tf_state_resource_group_name: tfstate-rg
      # tf_state_storage_account: powellrhystfstate
      # tf_state_container_name: tfstate
      # tf_state_key: powellrhys.tfstate
      should_apply: 'true'
      release_environment: 'PROD'
      tf_directory: 'infra'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
